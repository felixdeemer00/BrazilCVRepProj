---
title: "BrazilCVRepProj"
author: "Felix Deemer"
date: "5/4/2021"
output:
  html_document: default
  pdf_document: default
---

# Replication Project - Brazil Compulsory Voting Policy Analysis  
  
#### Original Paper: Compulsory Voting Can Increase Political Inequality: Evidence from Brazil
#### By Gabriel Cepaluni and F. Daniel Hidalgo

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(arm)
library(readr)
library(tidyverse)
library(mgcv)
library(lubridate)
library(plyr)
library(dplyr)
library(rdrobust)
library(rdd)
```

```{r Loading.RDataFile}

# The .RData file below consists of several datasets. The cadastro datasets 
# describe the results of a Brazilian national survey, while the svy_data set
# is the dataset created by the researchers, summarizing knowledge regarding
# access to state services affected by voting punishments.

load(file = "cepaluni_hidalgo.RData")

```

### Introduction

The original paper I attempted to replicate is a study of Compulsory Voting (CV) 
policies in Brazil, determining whether or not these policies achieve their 
desired effects. Compulsory voting policies are those that aim to increase
voter turnout by imposing financial or other penalties on those who fail to do
so. 

Cepaluni and Hidalgo's paper seeks to demonstrate that in the Brazilian
case, where every person between the ages of 18 and 69 is legally required to 
register and vote, such policies can actually be counterproductive in many ways. 
One aim of Brazil's policy was to reduce the extent of 'Political Inequality',
a phenomenon in which certain groups of people (wealthier, better educated, and
more privileged groups) tend to vote at higher rates, acquiring disproportionate
political influence. However, the punishment for not voting in Brazil involves 
restricted access to state services, which survey data collected by Cepaluni and
Hidalgo indicated are disproportionately used by more educated groups (education
levels were used as a proxy for wealth and privilege). This might mean, they
thought, that the CV policy would provide a greater incentive for more highly
educated individuals to vote, in fact increasing political inequality.

The researchers sought to investigate how large an effect CV policies have on 
turnout, and how the size of this effect varies according to education levels.
To analyze this effect, they used a Regression Discontinuity (RD) model, in 
which levels of a variable of interest are modeled on either side of a sharp 
threshold. This is well suited to CV policy analyses, as the CV policy has a
strict age cutoff. Therefore, by comparing turnout between 17-yr-olds (not 
required to vote) and 18-yr-olds (required to vote), and on the other end of
the range, between 69-yr-olds (required to vote) and 70-yr-olds (not required
to vote), this can reveal the causal effect of the policy. This is based off the
assumption that individuals just above and below the threshold will be very 
similar in most respects, and that there are not any systematic differences that
would make a comparison invalid.

To perform this analysis, they ran local linear models on either side of the
threshold (explained in detail below), calculating the difference between the 
two values in order to estimate the causal effect of the CV policy.

They concluded that the effect of the policy was somewhat larger for groups with
higher levels of education, with this difference being most pronounced between 
those who had completed at least primary education and those that had not. On
this basis, they concluded that far from reducing political inequality between
the educated and uneducated, Compulsory Voting policies in fact increased it.
The implications of this conclusion are that Compulsory Voting policies, when
they are implemented, should be more carefully designed to not backfire.

To replicate their model, I performed a Regression Discontinuity model as well,
although without the complex system of weighting used by theirs, instead using
a slightly simpler linear model. Although their data seemed designed to 
investigate the effect of CV on multiple different groups, so to extent their
analysis slightly I performed the same analysis based on sex instead of 
education. This allowed me to determine that the pattern seen in political 
inequality due to education (did/did not) extend to sex as well.

### State Service Usage

The research question originally carried out by Cepaluni and Hidalgo was largely
based on the survey finding that more educated individuals tend to make use of
Brazilian state services to a far greater extent. The survey results are shown
in the graph below. I used a t-test to determine the confidence intervals of
the mean number of state services used. The means indicate that as education
increases, the mean number of state services used also tends to increase, to
a greater degree with each increased level of education.

```{r StateServiceUsage}

## State service usage graph
# Creating the graph showing usage of state services, grouping by differing
# levels of education.

svy_data2 <- svy_data %>%
  group_by(edu_cat) %>%
  dplyr::summarize(mean = mean(num_state_services),
            lower = t.test(num_state_services)$conf.int[1],
            upper = t.test(num_state_services)$conf.int[2],
            .groups = "drop")

ggplot(data = svy_data2,
       mapping = aes(mean, edu_cat)) +
  geom_errorbar(aes(xmin = lower, xmax = upper), width = 0, col = "darkblue",
                lwd = 1) +
  geom_point(size = 3) +
  theme_get() +
  labs(y = "Education",
       x = "Mean Number of State Services Used")

```

### Data Cleaning

Three main data sources were used in the paper - a survey conducted by the 
researchers themselves, a general population survey, and registered voter data
from the Brazilian government.

To attempt to replicate the results obtained by Cepaluni and Hidalgo, I followed
a fairly similar data-cleaning process. I first filtered out those who are 
illiterate (they cannot vote and so should not be counted for the purposes of
this analysis), and added a day-of-the-week variable used later to impute 
missing population data. I also created a new variable 'primary_edu', which
was a 0/1 variable type showing whether or not the individual has completed
primary school. This was because in the original data, education was a 
categorical variable with multiple possible string values.

```{r DataCleaning}

## Cleaning the Data
# Dropping residents of Federal district

cadastro42 <- filter(cadastro42, uf != "DF", education != "Analfabeto")
cadastro92 <- filter(cadastro92, uf != "DF", education != "Analfabeto")
cadastro94 <- filter(cadastro94, uf != "DF", education != "Analfabeto")
pnad0513_1942 <- filter(pnad0513_1942, uf != "DF")
pnad0513_1994 <- filter(pnad0513_1994, uf != "DF")

# Adding a weekday variable, used later in the imputation model

cadastro42$weekday <- factor(wday(cadastro42$bdate, label = TRUE), ordered = FALSE)
cadastro42$weekday <- revalue(cadastro42$weekday, c("Thu"="Thurs", "Tue"="Tues"))

cadastro92$weekday <- factor(wday(cadastro92$bdate, label = TRUE), ordered = FALSE)
cadastro92$weekday <- revalue(cadastro92$weekday, c("Thu"="Thurs", "Tue"="Tues"))

cadastro94$weekday <- factor(wday(cadastro94$bdate, label = TRUE), ordered = FALSE)
cadastro94$weekday <- revalue(cadastro94$weekday, c("Thu"="Thurs", "Tue"="Tues"))

# Converting Gender, Marital Status and Education to 0/1 variables. Education 
# includes both a primary and secondary completion education variable.

cadastro42 <- mutate(cadastro42, 
                     primary_edu = ifelse(education %in% c("Analfabeto", 
                        "Ensino Fundamental Incompeto", "Le e Escreve"), 0, 1),
                     secondary_edu = ifelse(education %in% 
                        c("Ensino Medio Completo", "Superior Completo", 
                        "Superior Incompleto"), 1, 0),
                     woman = ifelse(sexo == "Feminino", 1, 0),
                     married = ifelse(marital_status == "Casado", 1, 0))
                    
cadastro92 <- mutate(cadastro92, 
                     primary_edu = ifelse(education %in% c("Analfabeto", 
                        "Ensino Fundamental Incompeto", "Le e Escreve"), 0, 1),
                     secondary_edu = ifelse(education %in% 
                        c("Ensino Medio Completo", "Superior Completo", 
                        "Superior Incompleto"), 1, 0),
                     woman = ifelse(sexo == "Feminino", 1, 0),
                     married = ifelse(marital_status == "Casado", 1, 0))

cadastro94 <- mutate(cadastro94, 
                     primary_edu = ifelse(education %in% c("Analfabeto", 
                        "Ensino Fundamental Incompeto", "Le e Escreve"), 0, 1),
                     secondary_edu = ifelse(education %in% 
                        c("Ensino Medio Completo", "Superior Completo", 
                        "Superior Incompleto"), 1, 0),
                     woman = ifelse(sexo == "Feminino", 1, 0),
                     married = ifelse(marital_status == "Casado", 1, 0))

```

### Discontinuity Graph

To begin the analysis, I attempted to recreate one of the author's graphs, which
showed visually the difference in turnout on either side of the CV threshold. To
do so, I summarized the election register data for the age 69-70 group (I began
with this group for reasons discussed later) by their date of birth. 

The proximity of their date of birth to the CV threshold is known as the 
'forcing variable', because depending on its value, an individual has a greater 
or lesser chance of undergoing treatment. Those with negative values of the 
forcing variable have their 70th birthday before the election, and thus are not 
obligated to vote as they fall outside the CV age range, while those with 
positive values are compelled to vote. 

A key assumption of the RD model is that individuals with relatively small 
values of the forcing variable will tend to be highly similar apart from having 
the treatment applied or not, so the causal effect can be much more clearly 
observed. As shown by the graph below, turnout experiences a significant jump
when the forcing variable crosses the threshold (the black dashed line, at fv = 
0). 

The key trend to observe here, however, is that while CV increases turnout 
for both the less educated and more educated groups, the effect is much greater
for the more educated group. Although both groups start off with a turnout of 
around 80%, the impact of CV makes highly educated turnout visibly higher than
less educated group turnout. 

The black dots indicate the average turnout within bins of 5 days, while the
lines are loess smoothing models used to visualize the trends of turnout on 
each side of the threshold. This is just an exploratory graph - in later 
sections, I quantify the exact size of the difference between the two effects.

```{r FVDiscontinuityGraph}
## Recreating the graph visually demonstrating the discontinuity on either side
## of the model.
# Creating the data for graphing the cohorts.

demo_cadastro <- dplyr::summarize(group_by(cadastro42, fv, primary_edu), 
                                 treat = unique(treat),
                                 weekday = factor(unique(weekday), ordered = FALSE),
                                 turnout = sum(turnout),
                                 registered = n(),
                                 .groups = "drop") %>%
  filter(abs(fv) <= 100) %>%
  mutate(pct_turnout = turnout/registered,
         bin5 = round(fv/5)*5,
         primary_edu = ifelse(primary_edu == 1, "Primary Education or More",
                              "Less than Primary Education"))

demo_cadastro_bin5 <- dplyr::summarize(group_by(demo_cadastro, bin5, primary_edu),
                                 turnout = sum(turnout),
                                 registered = sum(registered),
                                 .groups = "drop") %>%
  mutate(fv = bin5,
         pct_turnout = turnout / registered)

ggplot(demo_cadastro, aes(fv, pct_turnout)) +
  geom_point(alpha = 0.2) +
  geom_point(data = demo_cadastro_bin5) +
  geom_smooth(formula = y ~ x, data = filter(demo_cadastro, fv > 0), 
              method = "loess", se = FALSE, span = 2, lwd = 2, col = "darkgreen") +
  geom_smooth(formula = y ~ x, data = filter(demo_cadastro, fv < 0), 
              method = "loess", se = FALSE, span = 2, lwd = 2, col = "red") +
  geom_vline(xintercept = 0, lty = "dashed") +
  labs(title = "The Impact of Compulsory Voting on Turnout by Education",
       subtitle = " ",
       x = "Proximity of Birthday to Election Date (Forcing Variable)",
       y = "Turnout (%)") +
  annotate("text", x = 50, y = 0.89, label = "CV", col = "darkgreen", size = 5) +
  annotate("text", x = -50, y = 0.825, label = "No CV", col = "red", size = 5) +
  facet_wrap(~ primary_edu)
```

### Discontinuity Model

Do you walk us through the analysis you did for the replication?

Do you present the results well using tables and figures?
Do  you  explain  the  results?   i.e.,  Do  you  interpret  the  results  
(statistically and/or substantively) of the figures and tables?

For the model I fitted, I used a method closer to that demonstrated by the graph
below. For the data on either side of the threshold, I fitted a separate linear
regression model, 

```{r ModelExplanation}

ggplot(demo_cadastro, aes(fv, pct_turnout)) +
  geom_point(alpha = 0.2) +
  geom_point(data = demo_cadastro_bin5) +
  geom_smooth(formula = y ~ x, data = filter(demo_cadastro, fv > 0), 
              method = "lm", se = FALSE, span = 2, lwd = 2, col = "darkgreen") +
  geom_smooth(formula = y ~ x, data = filter(demo_cadastro, fv < 0), 
              method = "lm", se = FALSE, span = 2, lwd = 2, col = "red") +
  geom_vline(xintercept = 0, lty = "dashed") +
  labs(title = "The Impact of Compulsory Voting on Turnout by Education",
       subtitle = " ",
       x = "Proximity of Birthday to Election Date (Forcing Variable)",
       y = "Turnout (%)") +
  annotate("text", x = 50, y = 0.89, label = "CV", col = "darkgreen", size = 5) +
  annotate("text", x = -50, y = 0.825, label = "No CV", col = "red", size = 5) +
  facet_wrap(~ primary_edu)

```

```{r CoefficientCalculation}

coefcalc <- function(concadastro, bw, educ){
  
  cad_pos <- filter(concadastro, treat == 1, primary_edu %in% educ, 
                    abs(fv) <= bw)
  cad_neg <- filter(concadastro, treat == 0, primary_edu %in% educ, 
                    abs(fv) <= bw)
  
  pos_fit <- lm(turnout ~ fv, data = cad_pos, weights = registered)
  neg_fit <- lm(turnout ~ fv, data = cad_neg, weights = registered)
  
  return(rbind(summary(pos_fit)$coefficient, 
               summary(neg_fit)$coefficient))
}

```

### Bandwidth Selection and Graph

Do you walk us through the analysis you did for the replication?

Do you present the results well using tables and figures?
Do  you  explain  the  results?   i.e.,  Do  you  interpret  the  results  
(statistically and/or substantively) of the figures and tables?

```{r Bandwidth Chart}

coef_cadastro <- dplyr::summarize(group_by(cadastro42, fv, primary_edu), 
                                 treat = unique(treat),
                                 weekday = factor(unique(weekday), ordered = FALSE),
                                 turnout = mean(turnout),
                                 registered = n(),
                                 .groups = "drop") %>%
  filter(abs(fv) <= 365)

coef_fill <- function(educvals, educ, num, coefcadastro){
  
  coef = data.frame(posint = rep(0,350),
                   posse = rep(0,350),
                   negint = rep(0,350),
                   negse = rep(0,350),
                   educ = rep("",350))
  coef$Bandwidth <- seq.int(nrow(coef))
  
  for (i in 1:350){samp <- coefcalc(coefcadastro, i+14, educvals)
  coef[i,1] <- samp[1]
  coef[i,2] <- samp[1,2]
  coef[i,3] <- samp[3]
  coef[i,4] <- samp[3,2]
  coef[i,5] <- educ}
  
  return(coef)
  
}

coefs_full <- coef_fill(c(1,0), "Full Sample", 0, coef_cadastro)

coefs_uneduc <- coef_fill(0, "Less than Primary Education", 0, coef_cadastro)

coefs_educ <- coef_fill(1, "Primary Education or More", 0, coef_cadastro)

coefs_comb <- rbind(coefs_full, coefs_uneduc, coefs_educ) %>%
  mutate(diff = posint-negint,
         max = (posint + 1.96*posse)-(negint - 1.96*negse),
         min = (posint - 1.96*posse)-(negint + 1.96*negse)) %>%
  select(educ, Bandwidth, diff, max, min)

ggplot(data = coefs_comb, mapping = aes(y = diff, x = Bandwidth)) +
  geom_smooth(formula = y ~ x, method = "loess", se = FALSE, lwd = 1.5, 
              span = 0.2, color = "black") +
  geom_smooth(mapping = aes(y = max, x = Bandwidth),
              formula = y ~ x, method = "loess", se = FALSE, lwd = 0.5, 
              span = 0.2, color = "black", lty = "dashed") +
  geom_smooth(mapping = aes(y = min, x = Bandwidth),
              formula = y ~ x, method = "loess", se = FALSE, lwd = 0.5, 
              span = 0.2, color = "black", lty = "dashed") +
  facet_wrap(~ educ) +
  scale_y_continuous(breaks = c(-0.025, 0, 0.025, 0.05, 0.075), limits = c(-0.025, 0.08)) +
  labs(title = "Change of Estimate by Bandwidth",
       y = "Estimate of Change")

```

### Estimated CV Effect (Age 69-70 Group)

```{r 69-70CVCoef Educ}



```

### Unregistered Voter Estimate

Do you walk us through the analysis you did for the replication?

Do you present the results well using tables and figures?
Do  you  explain  the  results?   i.e.,  Do  you  interpret  the  results  
(statistically and/or substantively) of the figures and tables?

```{r UnregisteredVoterEstimate}

## Estimating voter registration shortfall
# This function estimates the number of people born each day, according to the
# day of the week.

est_pop <- function(pnad, cadastro){
  
  consolidated_pnad <- dplyr::summarize(group_by(pnad, fv), 
                                 weekday = factor(unique(weekday), ordered = FALSE),
                                 ppl = sum(sample_weight) / 
                                             length(unique(year)))
  
  pop_fit <- gam(ppl ~ weekday + s(fv), data = consolidated_pnad)
  
  consolidated_cadastro <- dplyr::summarize(group_by(cadastro, fv), 
                                 treat = unique(treat),
                                 weekday = factor(unique(weekday), ordered = FALSE),
                                 turnout = sum(turnout),
                                 registered = n())

  consolidated_cadastro$total_est <- round(predict(pop_fit, newdata = consolidated_cadastro))
  return(consolidated_cadastro)
  
  }
```

### Estimated CV Effect (Age 17-18 Group)

```{r 17-18CVCoef Educ}



```

### Extension: Political Inequality by Sex

```{r 69-70CVCoef Sex}



```

```{r 17-18CVCoef Sex}



```
